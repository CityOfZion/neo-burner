{"ast":null,"code":"\"use strict\"; // {{{1 Initialize matrix with zeros\n\nfunction init(version) {\n  var N = version * 4 + 17;\n  var matrix = [];\n  var zeros = new Buffer(N);\n  zeros.fill(0);\n  zeros = [].slice.call(zeros);\n\n  for (var i = 0; i < N; i++) {\n    matrix[i] = zeros.slice();\n  }\n\n  return matrix;\n} // {{{1 Put finders into matrix\n\n\nfunction fillFinders(matrix) {\n  var N = matrix.length;\n\n  for (var i = -3; i <= 3; i++) {\n    for (var j = -3; j <= 3; j++) {\n      var max = Math.max(i, j);\n      var min = Math.min(i, j);\n      var pixel = max == 2 && min >= -2 || min == -2 && max <= 2 ? 0x80 : 0x81;\n      matrix[3 + i][3 + j] = pixel;\n      matrix[3 + i][N - 4 + j] = pixel;\n      matrix[N - 4 + i][3 + j] = pixel;\n    }\n  }\n\n  for (var i = 0; i < 8; i++) {\n    matrix[7][i] = matrix[i][7] = matrix[7][N - i - 1] = matrix[i][N - 8] = matrix[N - 8][i] = matrix[N - 1 - i][7] = 0x80;\n  }\n} // {{{1 Put align and timinig\n\n\nfunction fillAlignAndTiming(matrix) {\n  var N = matrix.length;\n\n  if (N > 21) {\n    var len = N - 13;\n    var delta = Math.round(len / Math.ceil(len / 28));\n    if (delta % 2) delta++;\n    var res = [];\n\n    for (var p = len + 6; p > 10; p -= delta) {\n      res.unshift(p);\n    }\n\n    res.unshift(6);\n\n    for (var i = 0; i < res.length; i++) {\n      for (var j = 0; j < res.length; j++) {\n        var x = res[i],\n            y = res[j];\n        if (matrix[x][y]) continue;\n\n        for (var r = -2; r <= 2; r++) {\n          for (var c = -2; c <= 2; c++) {\n            var max = Math.max(r, c);\n            var min = Math.min(r, c);\n            var pixel = max == 1 && min >= -1 || min == -1 && max <= 1 ? 0x80 : 0x81;\n            matrix[x + r][y + c] = pixel;\n          }\n        }\n      }\n    }\n  }\n\n  for (var i = 8; i < N - 8; i++) {\n    matrix[6][i] = matrix[i][6] = i % 2 ? 0x80 : 0x81;\n  }\n} // {{{1 Fill reserved areas with zeroes\n\n\nfunction fillStub(matrix) {\n  var N = matrix.length;\n\n  for (var i = 0; i < 8; i++) {\n    if (i != 6) {\n      matrix[8][i] = matrix[i][8] = 0x80;\n    }\n\n    matrix[8][N - 1 - i] = 0x80;\n    matrix[N - 1 - i][8] = 0x80;\n  }\n\n  matrix[8][8] = 0x80;\n  matrix[N - 8][8] = 0x81;\n  if (N < 45) return;\n\n  for (var i = N - 11; i < N - 8; i++) {\n    for (var j = 0; j < 6; j++) {\n      matrix[i][j] = matrix[j][i] = 0x80;\n    }\n  }\n} // {{{1 Fill reserved areas\n\n\nvar fillReserved = function () {\n  var FORMATS = Array(32);\n  var VERSIONS = Array(40);\n  var gf15 = 0x0537;\n  var gf18 = 0x1f25;\n  var formats_mask = 0x5412;\n\n  for (var format = 0; format < 32; format++) {\n    var res = format << 10;\n\n    for (var i = 5; i > 0; i--) {\n      if (res >>> 9 + i) {\n        res = res ^ gf15 << i - 1;\n      }\n    }\n\n    FORMATS[format] = (res | format << 10) ^ formats_mask;\n  }\n\n  for (var version = 7; version <= 40; version++) {\n    var res = version << 12;\n\n    for (var i = 6; i > 0; i--) {\n      if (res >>> 11 + i) {\n        res = res ^ gf18 << i - 1;\n      }\n    }\n\n    VERSIONS[version] = res | version << 12;\n  }\n\n  var EC_LEVELS = {\n    L: 1,\n    M: 0,\n    Q: 3,\n    H: 2\n  };\n  return function fillReserved(matrix, ec_level, mask) {\n    var N = matrix.length;\n    var format = FORMATS[EC_LEVELS[ec_level] << 3 | mask];\n\n    function F(k) {\n      return format >> k & 1 ? 0x81 : 0x80;\n    }\n\n    ;\n\n    for (var i = 0; i < 8; i++) {\n      matrix[8][N - 1 - i] = F(i);\n      if (i < 6) matrix[i][8] = F(i);\n    }\n\n    for (var i = 8; i < 15; i++) {\n      matrix[N - 15 + i][8] = F(i);\n      if (i > 8) matrix[8][14 - i] = F(i);\n    }\n\n    matrix[7][8] = F(6);\n    matrix[8][8] = F(7);\n    matrix[8][7] = F(8);\n    var version = VERSIONS[(N - 17) / 4];\n    if (!version) return;\n\n    function V(k) {\n      return version >> k & 1 ? 0x81 : 0x80;\n    }\n\n    ;\n\n    for (var i = 0; i < 6; i++) {\n      for (var j = 0; j < 3; j++) {\n        matrix[N - 11 + j][i] = matrix[i][N - 11 + j] = V(i * 3 + j);\n      }\n    }\n  };\n}(); // {{{1 Fill data\n\n\nvar fillData = function () {\n  var MASK_FUNCTIONS = [function (i, j) {\n    return (i + j) % 2 == 0;\n  }, function (i, j) {\n    return i % 2 == 0;\n  }, function (i, j) {\n    return j % 3 == 0;\n  }, function (i, j) {\n    return (i + j) % 3 == 0;\n  }, function (i, j) {\n    return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0;\n  }, function (i, j) {\n    return i * j % 2 + i * j % 3 == 0;\n  }, function (i, j) {\n    return (i * j % 2 + i * j % 3) % 2 == 0;\n  }, function (i, j) {\n    return (i * j % 3 + (i + j) % 2) % 2 == 0;\n  }];\n  return function fillData(matrix, data, mask) {\n    var N = matrix.length;\n    var row,\n        col,\n        dir = -1;\n    row = col = N - 1;\n    var mask_fn = MASK_FUNCTIONS[mask];\n    var len = data.blocks[data.blocks.length - 1].length;\n\n    for (var i = 0; i < len; i++) {\n      for (var b = 0; b < data.blocks.length; b++) {\n        if (data.blocks[b].length <= i) continue;\n        put(data.blocks[b][i]);\n      }\n    }\n\n    len = data.ec_len;\n\n    for (var i = 0; i < len; i++) {\n      for (var b = 0; b < data.ec.length; b++) {\n        put(data.ec[b][i]);\n      }\n    }\n\n    if (col > -1) {\n      do {\n        matrix[row][col] = mask_fn(row, col) ? 1 : 0;\n      } while (next());\n    }\n\n    function put(byte) {\n      for (var mask = 0x80; mask; mask = mask >> 1) {\n        var pixel = !!(mask & byte);\n        if (mask_fn(row, col)) pixel = !pixel;\n        matrix[row][col] = pixel ? 1 : 0;\n        next();\n      }\n    }\n\n    function next() {\n      do {\n        if (col % 2 ^ col < 6) {\n          if (dir < 0 && row == 0 || dir > 0 && row == N - 1) {\n            col--;\n            dir = -dir;\n          } else {\n            col++;\n            row += dir;\n          }\n        } else {\n          col--;\n        }\n\n        if (col == 6) {\n          col--;\n        }\n\n        if (col < 0) {\n          return false;\n        }\n      } while (matrix[row][col] & 0xf0);\n\n      return true;\n    }\n  };\n}(); // {{{1 Calculate penalty\n\n\nfunction calculatePenalty(matrix) {\n  var N = matrix.length;\n  var penalty = 0; // Rule 1\n\n  for (var i = 0; i < N; i++) {\n    var pixel = matrix[i][0] & 1;\n    var len = 1;\n\n    for (var j = 1; j < N; j++) {\n      var p = matrix[i][j] & 1;\n\n      if (p == pixel) {\n        len++;\n        continue;\n      }\n\n      if (len >= 5) {\n        penalty += len - 2;\n      }\n\n      pixel = p;\n      len = 1;\n    }\n\n    if (len >= 5) {\n      penalty += len - 2;\n    }\n  }\n\n  for (var j = 0; j < N; j++) {\n    var pixel = matrix[0][j] & 1;\n    var len = 1;\n\n    for (var i = 1; i < N; i++) {\n      var p = matrix[i][j] & 1;\n\n      if (p == pixel) {\n        len++;\n        continue;\n      }\n\n      if (len >= 5) {\n        penalty += len - 2;\n      }\n\n      pixel = p;\n      len = 1;\n    }\n\n    if (len >= 5) {\n      penalty += len - 2;\n    }\n  } // Rule 2\n\n\n  for (var i = 0; i < N - 1; i++) {\n    for (var j = 0; j < N - 1; j++) {\n      var s = matrix[i][j] + matrix[i][j + 1] + matrix[i + 1][j] + matrix[i + 1][j + 1] & 7;\n\n      if (s == 0 || s == 4) {\n        penalty += 3;\n      }\n    }\n  } // Rule 3\n\n\n  function I(k) {\n    return matrix[i][j + k] & 1;\n  }\n\n  ;\n\n  function J(k) {\n    return matrix[i + k][j] & 1;\n  }\n\n  ;\n\n  for (var i = 0; i < N; i++) {\n    for (var j = 0; j < N; j++) {\n      if (j < N - 6 && I(0) && !I(1) && I(2) && I(3) && I(4) && !I(5) && I(6)) {\n        if (j >= 4 && !(I(-4) || I(-3) || I(-2) || I(-1))) {\n          penalty += 40;\n        }\n\n        if (j < N - 10 && !(I(7) || I(8) || I(9) || I(10))) {\n          penalty += 40;\n        }\n      }\n\n      if (i < N - 6 && J(0) && !J(1) && J(2) && J(3) && J(4) && !J(5) && J(6)) {\n        if (i >= 4 && !(J(-4) || J(-3) || J(-2) || J(-1))) {\n          penalty += 40;\n        }\n\n        if (i < N - 10 && !(J(7) || J(8) || J(9) || J(10))) {\n          penalty += 40;\n        }\n      }\n    }\n  } // Rule 4\n\n\n  var numDark = 0;\n\n  for (var i = 0; i < N; i++) {\n    for (var j = 0; j < N; j++) {\n      if (matrix[i][j] & 1) numDark++;\n    }\n  }\n\n  penalty += 10 * Math.floor(Math.abs(10 - 20 * numDark / (N * N)));\n  return penalty;\n} // {{{1 All-in-one function\n\n\nfunction getMatrix(data) {\n  var matrix = init(data.version);\n  fillFinders(matrix);\n  fillAlignAndTiming(matrix);\n  fillStub(matrix);\n  var penalty = Infinity;\n  var bestMask = 0;\n\n  for (var mask = 0; mask < 8; mask++) {\n    fillData(matrix, data, mask);\n    fillReserved(matrix, data.ec_level, mask);\n    var p = calculatePenalty(matrix);\n\n    if (p < penalty) {\n      penalty = p;\n      bestMask = mask;\n    }\n  }\n\n  fillData(matrix, data, bestMask);\n  fillReserved(matrix, data.ec_level, bestMask);\n  return matrix.map(function (row) {\n    return row.map(function (cell) {\n      return cell & 1;\n    });\n  });\n} // {{{1 export functions\n\n\nmodule.exports = {\n  getMatrix: getMatrix,\n  init: init,\n  fillFinders: fillFinders,\n  fillAlignAndTiming: fillAlignAndTiming,\n  fillStub: fillStub,\n  fillReserved: fillReserved,\n  fillData: fillData,\n  calculatePenalty: calculatePenalty\n};","map":null,"metadata":{},"sourceType":"script"}